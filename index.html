<!doctype html>
<html>
  <head>
    <title>JS1k, 1k demo submission [ID]</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <script>
      var b = document.body;
      document.body.clientWidth; // fix bug in webkit: http://qfox.nl/weblog/218
    </script>
    <script>
// abbreviate canvas methods
// for($ in a)a[$[0]+($[6]||'')]=a[$]

var A=Math
var H=100         // width,height
var p=[50,50]     // player's position
var F=G=0         // player's position increaser
var f,g           // temp for F,G
var X=0           // Experience
var N=M=[]        // map
var E=[]          // enemies [[x,y],...]
var w=30,h=15     // w,h of window into the map
var D=10          // depth of CA + number of enemies
var I=J=10        // pet coordinates

// get random number from [0,max)
R = function(m) {return~~(A.random()*m)}
// integer division
DIV = function(a,b) {return ~~(a/b)}
// is p (2-int array) on (x,y)
o = function(p,x,y){return p[0]==x&&p[1]==y?1:0}

onkeyup=onkeydown=function(e){
  m=e.type[5]?1:0
  e=e.keyCode

  if(e>=37&&e<=40){
    f=(e^37?e^39?F:m:-m)
    g=(e^38?e^40?G:m:-m)

    // if can move
    if( !M[p[1]+g][p[0]+f] ){ F=f ; G=g }

    return false
  }
}
redraw = function() {
  S='<pre>Exp: '+X
  for(i = A.max( p[1] - DIV(h,2) , 0 ) ; i < p[1] + DIV(h,2) ; i++) {
    S+='\n'
    for(j = A.max( p[0] - DIV(w,2) , 0 ) ; j < p[0] + DIV(w,2) ; j++) {
      e=' '
      for(k=0;k<D;k++)
        if ( o( E[k], j, i ) ) e=k
      S+=!M[i] ? ' ' : M[i][j]?'#':o(p,j,i)?'@':e
    }
  }
  b.innerHTML=S
}
// regenerate the map
regen = function(){
  for(i=0;i<H;i++){M[i]=[];for(j=0;j<H;j++){M[i][j]=(R(100)<40)?1:0}}
  for(i=0;i<H;i++){M[i][0]=1;M[i][H-1]=1;} // fill borders
  for(i=0;i<H;i++){M[0][i]=1;M[H-1][i]=1;} // same

  E=[]

  for(k = 0; k < D; k++){

    // put point on an empty place
    do{E[k]=[R(H),R(H)]}while(M[E[k][1]][E[k][0]])

    // redraw()
    // alert('redraw')
    N=[]
    for(i=0;i<H;i++) {
      N[i]=[]
      for(j=0;j<H;j++) {
        s=0
        for(n=-1;n<2;n++)for(m=-1;m<2;m++){
          s += !M[i+n] ? 1 : (mn=M[i+n][j+m]) ? 1 : mn!=!1
        }
        N[i][j] = o(p,j,i) ? 0 : s > 5 || (k < 5 && !s)
      }
    }
    M=N
  }
}
regen()
redraw()

setInterval(function(){
  if( !M[p[1]+G][p[0]+F] ){
    if( F!=0 || G!=0 )
      console.log(F,G)
    p[0]+=F
    p[1]+=G
    for(k=0;k<D;k++)
      if(o(E[k],p[0],p[1])) {
        X+=k
        do{E[k]=[R(H),R(H)]}while(M[E[k][1]][E[k][0]])
      }
  }

  redraw()
},100)
    </script>
  </body>
</html>